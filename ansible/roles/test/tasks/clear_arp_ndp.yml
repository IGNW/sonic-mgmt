# Clear NDP/ARP for one or all neighbors and observe updated NDP/ARP

- name: Show NDP table and get comma-separated values
  shell: show ndp  | grep -E '^[a-f0-9]+:' | sed -E 's/ +/,/g'
  register: ndp
  failed_when: ndp.stdout_lines|length == 0

- name: Show ARP table and get comma-separated values
  shell: show arp | grep -E '^[0-9]+\.' | sed -E 's/ +/,/g'
  register: arp
  failed_when: arp.stdout_lines|length == 0

- name: Parse ARP table lines into arrays
  set_fact:
    arp_entries: "{{ arp_entries|default([]) +  [item.split(',')] }}"
  with_items: "{{ arp.stdout_lines }}"

- name: Choose the first ARP entry for testing
  set_fact:
    chosen_arp_entry:
      parts: "{{ arp_entries[0] }}"
      raw: "{{ arp.stdout_lines[0] }}"
- debug: var=chosen_arp_entry

# FIXME: There is no 'clear arp' command. /usr/bin/clear just clears the screen
# FIXME: This test only works sometimes because the arp entry comes back too fast
- name: Clear the chosen ARP entry
  shell: ip neigh del {{ chosen_arp_entry.parts[0] }} dev {{ chosen_arp_entry.parts[2] }} && show arp | grep -E '^[0-9]+\.' | sed -E 's/ +/,/g'
  become: yes
  register: arp_2
  failed_when: chosen_arp_entry.raw in arp_2.stdout

# TODO: Add NDP test when possible
