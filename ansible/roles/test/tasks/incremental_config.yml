- debug: msg="Tests for the incremental configuration features of the cli"

- name: gather interface facts
  interface_facts:

- name: set initial variables
  set_fact:
    inactive_eth_iface_list: []
    ethernet_portchannel_interfaces: []
    test_ipv4_address: 10.200.4.5/24
    test_ipv6_address: fc00::aa07/126
    test_port_channel_name: PortChannel0999
    test_vlan: 999

- name: create inactive interface list
  set_fact:
    inactive_eth_iface_list: "{{ inactive_eth_iface_list }} + ['{{ item.device }}']"
  when: item.active == false and "Ethernet" in item.device 
  with_items: "{{ ansible_interface_facts.values() }}"

- name: verify that there are at least 4 inactive interfaces
  assert:
    that: (inactive_eth_iface_list | length) >= 4
    msg: This test requires at least four inactive Ethernet interfaces

- name: set test interface variable
  set_fact:
    test_ip_iface: "{{ inactive_eth_iface_list[0] }}"
    test_vlan_iface: "{{ inactive_eth_iface_list[-1] }}" 
    test_portchannel_members: ["{{ inactive_eth_iface_list[-2] }}","{{ inactive_eth_iface_list[-3] }}"]

- name: "Ansible | List all known variables and facts"
  debug:
    var: "{{ item }}"
  with_items:
    - inactive_eth_iface_list 
    - test_ip_iface
    - test_vlan_iface
    - test_portchannel_members

# Add and remove an ipv4 address from an interface
- name: run ipv4 tests
  include: incremental_config/incremental_config_ip.yml address={{test_ipv4_address}} interface={{test_ip_iface}} ip_type='ipv4' 

# Add and remove an ipv6 address from an interface
- name: run ipv6 tests
  include: incremental_config/incremental_config_ip.yml address={{test_ipv6_address}} interface={{test_ip_iface}} ip_type='ipv6' 

# Add and remove a vlan from an interface
- name: run vlan tests
  include: incremental_config/incremental_config_vlan.yml vlan={{test_vlan}} interface={{test_vlan_iface}}

# Add and remove a portchannel to the switch
- name: run portchannel tests
  include: incremental_config/incremental_config_portchannel.yml name={{test_port_channel_name}} members={{test_portchannel_members}}

# Add and remove some acl rules via the incremental updated command
- name: run acl update tests
  include: incremental_config/incremental_config_acl_incremental_update.yml

