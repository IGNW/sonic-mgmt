- block:
  - name: Gather interface information if not available
    interface_facts:
    when: ansible_interface_facts is not defined

  - name: Read the current interfaces status
    shell: show interfaces status | head
    register: show_interface_status

  - name: Extract the interfaces table from a previous command's output
    parse_text_table:
      text: "{{ show_interface_status.stdout }}"

  - name: Store the indices for the ports that operationally 'up'
    set_fact: candidate_ports="{{ candidate_ports|default([]) + [item] }}"
    with_items: "{{ minigraph_ports }}"
    when: parsed_table_dict[item]['Oper'] == "up"

  - name: Copy tests to the PTF container
    copy: src=roles/test/files/ptftests dest=/root
    delegate_to: "{{ ptf_host }}"

  # TODO: Select port(s) to have traffic sent to. Can I loop through all of them?
#  - include: ptf_runner.yml
#    vars:
#      ptf_test_name: IP packet fuzz test
#      ptf_test_dir: ptftests
#      ptf_test_path: ip_fuzz.IpFuzzTest
#      ptf_platform: remote
#      ptf_platform_dir: ptftests
#      ptf_test_params:
#        - port: 0
#      ptf_extra_options: "--relax --debug info --log-file /tmp/ip_fuzz.IpFuzzTest.{{lookup('pipe','date +%Y-%m-%d-%H:%M:%S')}}.log"
#
#    - name: Do basic sanity check after each test and allow recovery
#      include: base_sanity.yml
#      vars:
#        recover: "{{ allow_recover }}"
#
#    - name: Validate all interfaces are up and allow recovery
#      include: interface.yml
#      vars:
#        recover: "{{ allow_recover }}"
