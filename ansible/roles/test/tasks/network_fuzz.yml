- block:
  - name: Gather interface information if not available
    interface_facts:
    when: ansible_interface_facts is not defined

  - name: Read the current interfaces status
    shell: show interfaces status | head
    register: show_interface_status

  - name: Extract the interfaces table from a previous command's output
    parse_text_table:
      text: "{{ show_interface_status.stdout }}"

  - name: Store the indices for the ports that operationally 'up'
    set_fact: test_ports="{{ test_ports|default([]) + [minigraph_port_indices[item]] }}"
    with_items: "{{ minigraph_ports }}"
    when: parsed_table_dict[item]['Oper'] == "up"

  - name: Copy tests to the PTF container
    copy: src=roles/test/files/ptftests dest=/root
    delegate_to: "{{ ptf_host }}"

  - name: Run IP packet fuzz test
    include: roles/test/tasks/network_fuzz/ip_fuzz_random_port.yml
    vars:
      packet_count: 100

  - name: Run TCP packet fuzz test
    include: roles/test/tasks/network_fuzz/tcp_fuzz_random_port.yml
    vars:
      packet_count: 100

  - name: Run UDP packet fuzz test
    include: roles/test/tasks/network_fuzz/udp_fuzz_random_port.yml
    vars:
      packet_count: 100

  rescue:
    - name: Do basic sanity check after each test and allow recovery
      include: base_sanity.yml
      vars:
        recover: "{{ allow_recover }}"

    - name: Validate all interfaces are up and allow recovery
      include: interface.yml
      vars:
        recover: "{{ allow_recover }}"
