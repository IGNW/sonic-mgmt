# Show ARP, Clear ARP, and observe updated table

- name: Show ARP table and get comma-separated values
  shell: show arp | grep -E '^[0-9]+\.' | sed -E 's/ +/,/g'
  register: arp
  failed_when: arp.stdout_lines|length == 0
#- debug: var=arp
-
- name: Parse ARP table lines into arrays
  set_fact:
    arp_entries: "{{ arp_entries|default([]) +  [item.split(',')] }}"
  with_items: "{{ arp.stdout_lines }}"

- name: Choose the first ARP entry for testing
  set_fact:
    chosen_arp_entry:
      parts: "{{ arp_entries[0] }}"
      raw: "{{ arp.stdout_lines[0] }}"
#- debug: var=chosen_arp_entry

# Note: This test may fail because ndp entries comes back too fast
- name: Clear the chosen ARP entry
  shell: sonic-clear arp {{ chosen_arp_entry.parts[0] }} && show arp | grep -E '^[0-9]+\.' | sed -E 's/ +/,/g'
  register: arp_2
  failed_when: chosen_arp_entry.raw in arp_2.stdout
#- debug: var=arp_2

# Note: This test may fail because ndp entries comes back too fast
- name: Clear all ARP entries
  shell: sonic-clear {{ chosen_arp_entry.parts[0] }} && show arp | grep -E '^[0-9]+\.' | sed -E 's/ +/,/g'
  register: arp_2
  failed_when: arp_2.stdout_lines|length != 0
