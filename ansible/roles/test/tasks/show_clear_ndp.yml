# Show NDP, Clear NDP, and observe updated table

- name: Show NDP table and get comma-separated values
  shell: show ndp | grep -E '^[a-f0-9]+:' | sed -E 's/ +/,/g'
  register: ndp
  failed_when: ndp.stdout_lines|length == 0
#- debug: var=ndp

- name: Parse NDP table lines into arrays
  set_fact:
    ndp_entries: "{{ ndp_entries|default([]) +  [item.split(',')] }}"
  with_items: "{{ ndp.stdout_lines }}"

- name: Choose the first NDP entry for testing
  set_fact:
    chosen_ndp_entry:
      parts: "{{ ndp_entries[0] }}"
      raw: "{{ ndp.stdout_lines[0] }}"
#- debug: var=chosen_ndp_entry

# Note: This test may fail because ndp entries comes back too fast
- name: Clear the chosen NDP entry
  shell: sonic-clear ndp {{ chosen_ndp_entry.parts[0] }} && show ndp | grep -E '^[a-f0-9]+:' | sed -E 's/ +/,/g'
  register: ndp_2
  failed_when: chosen_ndp_entry.raw in ndp_2.stdout
#- debug: var=ndp_2

# Note: This test may fail because ndp entries comes back too fast
- name: Clear all NDP entries
  shell: sonic-clear {{ chosen_ndp_entry.parts[0] }} && show ndp | grep -E '^[a-f0-9]+:' | sed -E 's/ +/,/g'
  register: ndp_2
  failed_when: ndp_2.stdout_lines|length != 0
